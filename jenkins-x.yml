buildPack: docker
pipelineConfig:
  env:
    - name: PIPELINE_CODE
      value: edbi
    - name: ENTANDO_DOCKER_IMAGE_INFO_CONFIGMAP
      value: entando-docker-image-info-v6.1
  pipelines:
    pullRequest:
      build:
        replace: true
        steps:
          - loop:
              variable: SUBFOLDER
              values:
                - eap
                - wildfly
              steps:
                - sh: echo "This avoids unwanted kaniko command substitution"  &&  skaffold build -p ${SUBFOLDER} -f skaffold.yaml
                  name: container-build
                - sh: jx step post build --image "${DOCKER_REGISTRY}/${ORG}/${APP_NAME}-${SUBFOLDER}:$(cat VERSION)"
                  name: post-build
                - sh: kubectl patch configmap ${ENTANDO_DOCKER_IMAGE_INFO_CONFIGMAP} -n entando -p "{\"data\":{\"${APP_NAME}-${SUBFOLDER}\":\"{\\\"version\\\":\\\"${VERSION}\\\",\\\"executable-type\\\":\\\"${EXECUTABLE_TYPE}\\\",\\\"registry\\\":\\\"${DOCKER_REGISTRY}\\\",\\\"organization\\\":\\\"entando\\\"}\"}}"
                  name: update-image-map
      promote:
        replace: true
        steps: []
    release:
      build:
        replace: true
        steps:
          - sh: mvn clean package
            name: mvn-build
          - loop:
              variable: SUBFOLDER
              values:
                - eap
                - wildfly
              steps:
              - sh: echo "This avoids unwanted kaniko command substitution"  &&  skaffold build -p ${SUBFOLDER} -f skaffold.yaml
                name: container-build
              - sh: jx step post build --image "${DOCKER_REGISTRY}/${ORG}/${APP_NAME}-${SUBFOLDER}:$(cat VERSION)"
                name: post-build
              - sh: kubectl patch configmap ${ENTANDO_DOCKER_IMAGE_INFO_CONFIGMAP} -n entando -p "{\"data\":{\"${APP_NAME}-${SUBFOLDER}\":\"{\\\"version\\\":\\\"${VERSION}\\\",\\\"executable-type\\\":\\\"${EXECUTABLE_TYPE}\\\",\\\"registry\\\":\\\"${DOCKER_REGISTRY}\\\",\\\"organization\\\":\\\"entando\\\"}\"}}"
                name: update-image-map
#              - dir: charts/preview
#                sh: make preview
#                name: make-preview
#              - dir: charts/preview
#                sh: jx preview --name ${REPO_NAME}-${SUBFOLDER}-${PIPELINE_CODE}ms --app $APP_NAME --dir ../.. --namespace ${REPO_NAME}-${SUBFOLDER}-${PIPELINE_CODE}ms
#                name: jx-preview
#          - sh: run-inter-process-tests
#            name: run-inter-process-tests
      promote:
        replace: true
        steps: []
